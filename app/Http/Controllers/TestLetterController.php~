<?php

namespace App\Http\Controllers;

use App\Helpers\Helper;
use App\Http\Requests\FormTestLetterRequest;
use App\Http\Requests\UploadPhysicalTestRequest;
use App\Services\TestLetter\TestLetterService;
use Illuminate\Http\Request;

class TestLetterController extends Controller
{
    protected $testLetterService;
    public function __construct(TestLetterService $testLetterService)
    {
        $this->testLetterService = $testLetterService;
    }

    public function index(Request $request)
    {
        $data['test_letters'] = $this->testLetterService->findAllByUserId()->getResult();

        return view('apps.test-letter.index', $data);
    }

    public function form(Request $request, $id = null)
    {
        if (auth()->user()->isGuest() && auth()->user()->isVerified()) {
            $data['test_letter'] = @$this->testLetterService->find(Helper::decrypt($id))->getResult();
            $data['form_step'] = $request->query('form-step');
            return view('apps.test-letter.form', $data);
        }

        return abort(403);
    }

    public function upsert_form(FormTestLetterRequest $request)
    {
        if (auth()->user()->isAdmin()) {
            return abort(403);
        }

        $data = $request->only(['workshop_type',
            'sop_component_installation',
            'technical_drawing',
            'conversion_workshop_certificate',
            'electrical_diagram',
            'photocopy_stnk',
            'physical_inspection',
            'test_report',
            'id',
            'responsible_person',
            'telephone',
            'address',
            'workshop','form_step',
            'brand',
            'type',
            'type_vehicle',
            'trademark',
            'country_of_origin',
            'variant',
            'allotment',
            'transmission',
            'drive_system',
            'chassis',
            'chassis_place_number',
            'chassis_method_number',
            'pre_conversion_engine',
            'pre_conversion_engine_place_number',
            'pre_conversion_engine_method_number',
            'post_conversion_engine',
            'post_conversion_engine_place_number',
            'post_conversion_engine_method_number',
            'brand_drive_motor',
            'type_drive_motor',
            'location_drive_motor',
            'voltage_drive_motor',
            'ampere_drive_motor',
            'power_drive_motor',
            'power_max_drive_motor',
            'rotation_drive_motor',
            'conversion_voltage_fuel_system','electrical_voltage_fuel_system','battery_capacity_fuel_system',
            'total_length_vehicle_dimension','']);
        return $this->testLetterService->upsert_form($data)->toJson();
    }

    public function table()
    {
        if (!auth()->user()->isAdmin()) {
            return abort(403);
        }

        return $this->testLetterService->table();
    }

    public function show(Request $request)
    {
        $data['test_letter'] = $this->testLetterService->find(Helper::decrypt($request->id))->getResult();
        return view('apps.test-letter.detail', $data);
    }

    public function verification($id)
    {
        if (!auth()->user()->isAdmin()) {
            return abort(403);
        }

        $data['test_letter'] = $this->testLetterService->find(Helper::decrypt($id))->getResult();

        return view('apps.test-letter.verification', $data);
    }

    public function approve(Request $request)
    {
        if (!auth()->user()->isAdmin()) {
            return abort(403);
        }


        $data = $request->only(['id','is_verified']);

        return $this->testLetterService->approve($data)->toJson();
    }

    public function upload_physical_test_letter(UploadPhysicalTestRequest $request)
    {
        if (auth()->user()->isAdmin()) {
            return abort(403);
        }

        $data = $request->only(['physical_test_bpljskb', 'id']);
        return $this->testLetterService->upload_physical_test_letter($data)->toJson();
    }

    public function show_physical_test_letter(Request $request)
    {
        if (auth()->user()->isAdmin()) {
            return abort(404);
        }

        return $this->testLetterService->findOrFail($request->id)->toJson();
    }

    public function certificate($id)
    {
        if (!auth()->user()->isAdmin()) {
            return abort(403);
        }

        $data['test_letter'] = $this->testLetterService->find(Helper::decrypt($id))->getResult();

        return view('apps.test-letter.certificate', $data);
    }
}
